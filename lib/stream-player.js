// Generated by CoffeeScript 1.9.3
var Speaker, StreamPlayer, audioOptions, events, lame, request, self,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

Speaker = require('speaker');

lame = require('lame');

request = require('request');

events = require('events');

audioOptions = {
  channels: 2,
  bitDepth: 16,
  sampleRate: 44100,
  mode: lame.STEREO
};

self = null;

StreamPlayer = (function(superClass) {
  extend(StreamPlayer, superClass);

  function StreamPlayer() {
    events.EventEmitter.call(this);
    self = this;
    this.queue = [];
    this.trackInfo = [];
  }

  StreamPlayer.prototype.play = function() {
    var nextSongUrl;
    nextSongUrl = this.queue[0];
    if (typeof nextSongUrl !== 'undefined') {
      return this.getStream(nextSongUrl, this.playStream);
    } else {
      return new Error('The queue is empty.');
    }
  };

  StreamPlayer.prototype.add = function(url, track) {
    this.queue.push(url);
    this.trackInfo.push(track);
    return this.emit('song added');
  };

  StreamPlayer.prototype.nowPlaying = function() {
    var song;
    song = this.trackInfo[0];
    if (typeof song !== 'undefined') {
      return song;
    } else {
      return new Error('No metadata was given.');
    }
  };

  StreamPlayer.prototype.getQueue = function() {
    return this.trackInfo;
  };

  StreamPlayer.prototype.getStream = function(url, callback) {
    return request.get(url).on('response', function(res) {
      return callback(res);
    });
  };

  StreamPlayer.prototype.playStream = function(stream) {
    var decoder, speaker;
    decoder = new lame.Decoder();
    speaker = new Speaker(audioOptions);
    return stream.pipe(decoder).once('format', function() {
      decoder.pipe(speaker);
      self.emit('play start');
      return speaker.once('close', function() {
        self.emit('play end');
        self.queue.shift();
        self.trackInfo.shift();
        return self.play();
      });
    });
  };

  return StreamPlayer;

})(events.EventEmitter);

module.exports = StreamPlayer;
